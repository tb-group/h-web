<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>H+ 后台主题UI框架 - 首页示例三</title>
    <meta name="keywords" content="H+后台主题,后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description" content="H+是一个完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">

    <link rel="shortcut icon" href="favicon.ico"> <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <!-- Morris -->
    <link href="css/plugins/morris/morris-0.4.3.min.css" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">

	<!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
</head>

<body class="gray-bg">

    <div class="wrapper wrapper-content">
        <div class="row">
           <div class="col-sm-12">
		      <div class="ibox float-e-margins">
                 <div class="ibox-content" style="height: 450px;border:5px solid white" id="container11">
		         </div>
			  </div>
	       </div>
		</div>

        <div class="row">
           <div class="col-sm-12">
		      <div class="ibox float-e-margins">
			  <div class="ibox-content">
                 <table id="dataTable"></table>
              </div>
			  </div>
	       </div>
		</div>

        <div  id="dashboard" class="row">
            <div class="col-lg-4">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>仪表盘</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
					<style> 
					.div-inline{ float:left;}
					</style>
                    <div class="ibox-content col-lg-4" style="height:200px" >
                        <div class="div-inline" style="height:200px; width:25%" id="gauge1"></div>
						<div class="div-inline" style="height:200px; width:25%" id="gauge2"></div>
						<div class="div-inline" style="height:200px; width:25%" id="gauge3"></div>
						<div class="div-inline" style="height:200px; width:25%" id="gauge4"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-warning pull-right">年</span>
                        <h5>TSP</h5>
                    </div>
                    <div class="ibox-content">
                        <div style="height:225px; width:100%" id="tspcontainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">

        </div>

    </div>


    <!-- 全局js -->
    <script src="js/jquery.min.js?v=2.1.4"></script>
    <script src="js/bootstrap.min.js?v=3.3.6"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
    <!-- Latest compiled and minified Locales -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-CN.min.js"></script>

    <!-- Flot -->
    <script src="js/plugins/flot/jquery.flot.js"></script>
    <script src="js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="js/plugins/flot/jquery.flot.spline.js"></script>
    <script src="js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="js/plugins/flot/jquery.flot.symbol.js"></script>
    <script src="js/plugins/flot/curvedLines.js"></script>

    <!-- Peity -->
    <script src="js/plugins/peity/jquery.peity.min.js"></script>
    <script src="js/demo/peity-demo.js"></script>

    <!-- 自定义js -->
    <script src="js/content.js?v=1.0.0"></script>


    <!-- jQuery UI -->
    <script src="js/plugins/jquery-ui/jquery-ui.min.js"></script>

    <!-- Jvectormap -->
    <script src="js/plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>

    <!-- EayPIE -->
    <script src="js/plugins/easypiechart/jquery.easypiechart.js"></script>

    <!-- Sparkline -->
    <script src="js/plugins/sparkline/jquery.sparkline.min.js"></script>

    <!-- Sparkline demo data  -->
    <script src="js/demo/sparkline-demo.js"></script>

    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=9051096" charset="UTF-8"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=uVUiGv4jxH8CiHW7HeuyUHSDv7bvfyeK"></script>
    <script type="text/javascript" src="js/baidu.js" charset="UTF-8"></script>
    <script type="text/javascript" src="js/mainutils.js" charset="UTF-8"></script>
    <script type="text/javascript" src="js/restutils.js" charset="UTF-8"></script>
    <!--统计代码，可删除-->
 <script>
    function updateDeviceData() {
        var allDevices = (sessionStorage.getItem('allProjecInfo'));
	    var jsonDevices = JSON.parse(allDevices);
        setMarkers(jsonDevices);
        var $dataTableHot = $("#dataTable").bootstrapTable({
            search: false,
            pagination: true,
            pageSize: 15,
            pageList: [5, 10, 15, 20],
            showColumns: true,
            showRefresh: false,
            locale: "zh-CN",
            striped: true,
            toggle:true,
			data: jsonDevices,
            columns:[{
                field: "address",
                title:"address"
            },{
                field: "district",
                title:"district"
            }, {
                field: "contractors",
                title:"contractors"
            }]
        });
	}   
</script>

<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>
<script type="text/javascript">
    var myChart1 = echarts.init(document.getElementById("gauge1"));
        option1 = {
            tooltip : {
            formatter: "{a} <br/>{b} : {c}%"
        },
        series: [
        {
            name: '业务指标',
            type: 'gauge',
		    radius: "95%",
            axisLine: {
			    lineStyle: {
			         width:15
			        }
			},

            detail: {formatter:'{value}%'},
            data: [{value: 50, name: 'TSP', textStyle: { fontSize: 7 }}]
        }]
    };
    var myChart2 = echarts.init(document.getElementById("gauge2"));
        option2 = {
        tooltip : {
            formatter: "{a} <br/>{b} : {c}%"
        },
        series: [
        {
            name: '业务指标',
            type: 'gauge',
		    radius: "95%",
            axisLine: {
			    lineStyle: {
			         width:10
			        }
			},

            detail: {formatter:'{value}%'},
            data: [{value: 50, name: '噪声', textStyle: { fontSize: 7 }}]
        }]
    };
    var myChart3 = echarts.init(document.getElementById("gauge3"));
        option3 = {
            tooltip : {
                formatter: "{a} <br/>{b} : {c}毫克"
        },
        series: [
        {
            name: '业务指标',
            type: 'gauge',
		    radius: "95%",
            axisLine: {
			    lineStyle: {
			         width:10
			        }
			},

            detail: {formatter:'{value}毫克'},
            data: [{value: 50, name: 'PM2.5', textStyle: { fontSize: 7 }}]
        }]
    };
    var myChart4 = echarts.init(document.getElementById("gauge4"));
    option4 = {
        tooltip : {
            formatter: "{a} <br/>{b} : {c}°C"
        },
        series: [
        {
            name: '业务指标',
            type: 'gauge',
		    radius: "95%",
            axisLine: {
			    lineStyle: {
			         width:10
			        }
			},

            detail: {formatter:'{value}°C'},
            data: [{value: 50, name: '温度', textStyle: { fontSize: 7 }}]
        }]
    };

    function updateGauge() {
        var device_name = sessionStorage.getItem('current_device');
        var allDevices = (sessionStorage.getItem('allProjecInfo'));
        var jsonDevices = JSON.parse(allDevices);
        option1.series[0].data[0].value = 0;
        option2.series[0].data[0].value = 0;
        option3.series[0].data[0].value = 0;
        option4.series[0].data[0].value = 0;
        jsonDevices.forEach(function(device){
            if(device.devname == device_name) {
                option1.series[0].data[0].value = device.last_tspvalue;
                option2.series[0].data[0].value = device.last_noisevalue;
                option3.series[0].data[0].value = device.last_pm25value;
			    option4.series[0].data[0].value = device.last_tempvalue;
            }
        });

        myChart1.setOption(option1, true);
        myChart2.setOption(option2, true);
        myChart3.setOption(option3, true);
        myChart4.setOption(option4, true);
    }
</script>

<script type="text/javascript">
    function convertDateFromString(dateString) { 
       if (dateString) { 
         var arr1 = dateString.split(" "); 
         var sdate = arr1[0].split('-'); 
         var date = new Date(sdate[0], sdate[1]-1, sdate[2]); 
         return date;
      } 
    }

    var dom = document.getElementById("tspcontainer");
    var tspChart = echarts.init(dom);
    var updateFlag = true;

    function updateTspTimeseries() {
      if(!updateFlag) return;
      var tspData = JSON.parse(sessionStorage.getItem('telemetrysTimeseries'));
      var data = [];
      tspData.forEach(function(item){
	     data.push([item['datetime'], parseFloat(item['value_real'])]);
      });
      console.log(data);
      tspoption = {
        grid: [{
            left: 40,
            right: 120,
            height: '35%'
        }],
        tooltip: {
            trigger: 'axis'
        },
        xAxis: {
            data: data.map(function (item) {
                return item[0];
            })
        },
        yAxis: {
            splitLine: {
                show: false
            }
        },
        toolbox: {
            left: 'center',
            feature: {
                dataZoom: {
                    yAxisIndex: 'none'
                },
                restore: {},
                saveAsImage: {}
            }
        },
        dataZoom: [{
            show:true,
            realtime : true, 
		},{
            type: 'inside',
            realtime : true, 
        }],
        visualMap: {
            top: 10,
            right: 10,
            pieces: [{
                gt: 0,
                lte: 50,
                color: '#096'
            }, {
                gt: 50,
                lte: 100,
                color: '#ffde33'
            }, {
                gt: 100,
                lte: 150,
                color: '#ff9933'
            }, {
                gt: 150,
                lte: 200,
                color: '#cc0033'
            }, {
                gt: 200,
                lte: 300,
                color: '#660099'
            }, {
                gt: 300,
                color: '#7e0023'
            }],
            outOfRange: {
                color: '#999'
            }
        },
        series: {
            name: 'TSP',
            type: 'line',
            data: data.map(function (item) {
                return item[1];
            }),
            markLine: {
                silent: true,
                data: [{
                    yAxis: 50
                }, {
                    yAxis: 100
                }, {
                    yAxis: 150
                }, {
                    yAxis: 200
                }, {
                    yAxis: 300
                }]
            }
        }
    };

      tspChart.setOption(tspoption, true); 
    }

    tspChart.on('datazoom', function (params){
       updateFlag = false;
       //console.log(params);
       var dataZoom = tspChart.getModel().option.dataZoom[0];
       //console.log(dataZoom);
    });

    tspChart.on('restore', function (params){
       console.log(params);
       updateFlag = true;
    });

</script>
<script type="text/javascript">
    function updateDashboard(device_name) {
        document.getElementById("dashboard").scrollIntoView();
        sessionStorage.setItem('current_device', device_name);
    }

    $(function () {
        setInfoWindowOnclick(updateDashboard);

        $.subscribe('app.myevent', function(e, results) {
           console.log(JSON.parse(results));
        });

        $.subscribe('app.devicesUpdate', function(e, results) {
           updateDeviceData();
           updateGauge();
        });

        $.subscribe('app.devicesTelemetrysUpdate', function(e, results) {
           updateTspTimeseries();
        });

        getAllProjectInfo();

        var before = 1535904000;
        setInterval(function () {
           getAllProjectInfo();
           var device_name = sessionStorage.getItem('current_device');
           if(null != device_name) {
              param = 'before='+before.toString() + '&length=3600';
              getDeviceTelemetrys(device_name, param);
              before = before + 5;
           }
           var array13 = new Array("a","b","c",1,2,3,true,false);
           $.publish('app.myevent', JSON.stringify(array13));}, 5000);
    });
</script>

</body>

</html>
